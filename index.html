<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reserva de Chromebooks</title>
  <style>
    /* RESET & BASICS */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #ff9a56 0%, #ffad56 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex; justify-content: center; align-items: center;
      padding: 2rem;
    }

    /* CARD */
    .container {
      background-color: #ffffff;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      width: 100%; max-width: 520px;
      animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* HEADER */
    .header { text-align: center; margin-bottom: 2rem; }
    .icon { font-size: 3rem; margin-bottom: 0.5rem; }
    h1 { color: #1a202c; font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
    .subtitle { color: #718096; font-size: 0.95rem; }

    /* FORM ELEMENTS */
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; margin-bottom: 0.5rem; color: #2d3748; font-weight: 600; font-size: 0.9rem; }
    
    input, select {
      width: 100%; padding: 0.8rem; border: 2px solid #e2e8f0;
      border-radius: 10px; font-size: 1rem; background-color: #f7fafc;
      transition: 0.3s;
    }
    input:focus { outline: none; border-color: #ff8c42; background: #fff; }

    /* INVENT츼RIO DISPLAY */
    #total-display {
      text-align: center; padding: 0.8rem; margin-bottom: 1.5rem;
      background: #fffaf0; border: 2px solid #ff8c42; border-radius: 10px;
      color: #c05621; font-weight: bold;
    }

    /* HOR츼RIOS CONTAINER */
    .horarios-container {
      max-height: 250px; overflow-y: auto;
      border: 2px solid #e2e8f0; border-radius: 10px; padding: 1rem;
      background: #f7fafc; position: relative;
    }
    
    /* Loader interno dos hor치rios */
    .loader-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8); z-index: 5;
      display: none; flex-direction: column;
      align-items: center; justify-content: center; font-weight: bold;
      color: #2d3748;
    }
    .horarios-container.loading .loader-overlay { display: flex; }
    
    .checkbox-item {
      display: flex; align-items: center; padding: 0.5rem;
      border-radius: 6px; margin-bottom: 0.2rem; cursor: pointer;
    }
    .checkbox-item:hover { background: #edf2f7; }
    .checkbox-item input { width: auto; margin-right: 10px; cursor: pointer; accent-color: #ff8c42; }
    .checkbox-item label { margin: 0; cursor: pointer; flex: 1; font-weight: 500; line-height: 1.4; }
    
    /* Status Colors */
    .status-ok { color: #2f855a; font-size: 0.85em; margin-left: 5px; }
    .status-full { color: #c53030; font-size: 0.85em; margin-left: 5px; font-weight: bold; }
    
    .checkbox-item.disabled { opacity: 0.5; pointer-events: none; background-color: #f7fafc; }
    .checkbox-item.disabled label { text-decoration: line-through; color: #a0aec0; }

    /* BUTTON */
    button {
      width: 100%; padding: 1rem; border: none; border-radius: 12px;
      background: linear-gradient(135deg, #ff8c42 0%, #ffad56 100%);
      color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 140, 66, 0.4); }
    button:disabled { background: #ccc; transform: none; cursor: not-allowed; }

    /* GLOBAL LOADER (Spinner) */
    #global-loader {
      display: none; margin: 1rem auto; width: 30px; height: 30px;
      border: 4px solid #eee; border-top: 4px solid #ff8c42; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* MESSAGES */
    #message {
      display: none; margin-top: 1rem; padding: 1rem; border-radius: 10px;
      text-align: center; font-weight: bold;
    }
    .msg-success { background: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4; }
    .msg-error { background: #fed7d7; color: #742a2a; border: 1px solid #fc8181; text-align: left; }

    /* MOBILE RESPONSIVE */
    @media(max-width: 600px) {
      .container { padding: 1.5rem; }
      body { padding: 1rem; }
      h1 { font-size: 1.4rem; }
      .icon { width: 56px; height: 56px; font-size: 1.75rem; }
      input, select, button { padding: 0.8rem; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="icon">游냏</div>
    <h1>Reserva de Chromebooks</h1>
    <p class="subtitle">Bright Bee</p>
  </div>

  <div id="total-display">Aguardando sala...</div>

  <form id="reserva-form">
    <div class="form-group">
      <label>Sala (ex: LV-3.12, FD-2.02 ou SC-2.6)</label>
      <input type="text" id="sala" required placeholder="Digite a sala (ex: LV-3.12)" onblur="buscarEstoque()">
    </div>

    <div class="form-group">
      <label>Seu Nome (Professor)</label>
      <input type="text" id="professor" required placeholder="Ex: Prof. Silva">
    </div>

    <div class="form-group">
      <label>Seu E-mail</label>
      <input type="email" id="email" required placeholder="para receber confirma칞칚o">
    </div>

    <div class="form-group">
      <label>Data da Reserva</label>
      <input type="date" id="data" required onchange="checarDisponibilidade()">
    </div>

    <div class="form-group">
      <label>Quantidade (M치x: 25)</label>
      <input type="number" id="quantidade" min="1" max="25" required placeholder="Qtd alunos">
    </div>

    <div class="form-group">
      <label>Hor치rios</label>
      <div id="horarios-box" class="horarios-container">
        <div class="loader-overlay">
            <div style="width: 20px; height: 20px; border: 3px solid #333; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 5px;"></div>
            Verificando...
        </div>
        
        <div class="checkbox-item"><input type="checkbox" value="07:00 - 07:45" name="h"><label>07:00 - 07:45 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="07:45 - 08:30" name="h"><label>07:45 - 08:30 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="08:30 - 09:15" name="h"><label>08:30 - 09:15 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="09:45 - 10:30" name="h"><label>09:45 - 10:30 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="10:30 - 11:15" name="h"><label>10:30 - 11:15 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="11:15 - 12:00" name="h"><label>11:15 - 12:00 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="12:00 - 12:45" name="h"><label>12:00 - 12:45 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="13:15 - 14:00" name="h"><label>13:15 - 14:00 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="14:00 - 14:45" name="h"><label>14:00 - 14:45 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="14:45 - 15:30" name="h"><label>14:45 - 15:30 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="15:30 - 16:15" name="h"><label>15:30 - 16:15 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="16:45 - 17:30" name="h"><label>16:45 - 17:30 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="17:30 - 18:15" name="h"><label>17:30 - 18:15 <span class="status"></span></label></div>
        <div class="checkbox-item"><input type="checkbox" value="18:15 - 19:00" name="h"><label>18:15 - 19:00 <span class="status"></span></label></div>
      </div>
    </div>

    <button type="submit" id="btn-submit">Confirmar Reserva</button>
  </form>

  <div id="global-loader"></div>
  <div id="message"></div>
</div>

<script>
  // --- CONFIGURA칂츾O ---
  // IMPORTANTE: Se voc칡 reimplantou o backend, atualize a URL aqui.
  const API_URL = "https://script.google.com/macros/s/AKfycbwGglxy4tGww82iD_N74uIohgbi8hOacsfE0EqSfNHeB-zk8I4fjUvEP-5wGoLe6w86ng/exec";

  let totalEstoque = 0;
  let disponibilidadeMap = {};

  window.onload = function() {
    // Configura data m칤nima para AMANH츾
    const amanha = new Date();
    amanha.setDate(amanha.getDate() + 1);
    const amanhaString = amanha.toISOString().split("T")[0];
    document.getElementById("data").min = amanhaString;
    
    // Pega par칙metro da URL (ex: ?sala=LV-3.12)
    const urlParams = new URLSearchParams(window.location.search);
    const salaParam = urlParams.get('sala');
    
    if (salaParam) {
      document.getElementById("sala").value = salaParam;
      buscarEstoque(); 
    }
  };

  async function callApi(payload) {
    const res = await fetch(API_URL, {
      method: "POST",
      redirect: "follow",
      headers: {
        "Content-Type": "text/plain;charset=utf-8",
      },
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  // Fun칞칚o de Valida칞칚o de Sala (Front-end)
  function validarSala(sala) {
    const s = sala.toUpperCase().trim();
    // Regex: Come칞a com 2 letras, h칤fen, n칰meros, ponto, n칰meros
    const regex = /^[A-Z]{2}-\d+\.\d+$/; // Ex: LV-3.12
    
    if (!regex.test(s)) {
      return { valido: false, msg: "Formato inv치lido! Use: XX-Andar.Sala (ex: LV-3.12, SC-2.6)" };
    }
    
    const prefixo = s.substring(0, 3);
    if (prefixo !== "LV-" && prefixo !== "FD-" && prefixo !== "SC-") {
      return { valido: false, msg: "Sala deve come칞ar com LV-, FD- ou SC-" };
    }
    
    return { valido: true };
  }

  function buscarEstoque() {
    const salaVal = document.getElementById("sala").value;
    const display = document.getElementById("total-display");
    
    if(!salaVal) {
        display.innerText = "Digite a Sala para ver o estoque.";
        return;
    }

    // Valida칞칚o de formato antes de ir para o servidor
    const validacao = validarSala(salaVal);
    if (!validacao.valido) {
      display.innerText = validacao.msg;
      display.style.color = "red";
      return;
    }
    display.style.color = "#c05621"; // Reseta cor

    display.innerText = "Consultando estoque...";

    callApi({ action: "consultarInventario", sala: salaVal })
      .then(data => {
        if (data.success) {
          totalEstoque = data.total; // Recebe 25 do backend
          const tipo = data.context; 
          display.innerText = `Estoque ${tipo}: ${totalEstoque} Chromebooks`;
          
          const max = Math.min(25, totalEstoque);
          document.getElementById("quantidade").max = max;
          
          checarDisponibilidade();
        } else {
          display.innerText = "Erro: " + data.message;
        }
      })
      .catch(e => {
        console.error(e);
        display.innerText = "Erro de conex칚o com o servidor.";
      });
  }

  function checarDisponibilidade() {
    const dataVal = document.getElementById("data").value;
    const salaVal = document.getElementById("sala").value;
    const box = document.getElementById("horarios-box");
    
    resetarCheckboxes();

    if (!dataVal || !salaVal) return;

    box.classList.add("loading");

    callApi({ action: "consultarDisponibilidadeData", data: dataVal, sala: salaVal })
      .then(resp => {
        box.classList.remove("loading");
        if (resp.success) {
          disponibilidadeMap = resp.map;
          atualizarInterfaceHorarios();
        }
      })
      .catch(e => {
        box.classList.remove("loading");
        console.error(e);
      });
  }

  function resetarCheckboxes() {
    const inputs = document.querySelectorAll("input[name='h']");
    inputs.forEach(inp => {
      inp.disabled = false;
      inp.checked = false;
      inp.parentElement.classList.remove("disabled");
      inp.nextElementSibling.querySelector(".status").innerText = "";
    });
  }

  function atualizarInterfaceHorarios() {
    const inputs = document.querySelectorAll("input[name='h']");
    inputs.forEach(inp => {
      const horario = inp.value;
      const livres = disponibilidadeMap[horario] !== undefined ? disponibilidadeMap[horario] : totalEstoque;
      const span = inp.nextElementSibling.querySelector(".status");
      
      if (livres <= 0) {
        inp.disabled = true;
        inp.parentElement.classList.add("disabled");
        span.innerText = "(Esgotado)";
        span.className = "status status-full";
      } else {
        span.innerText = `(${livres} livres)`;
        span.className = "status status-ok";
      }
    });
  }

  document.getElementById("reserva-form").addEventListener("submit", function(e) {
    e.preventDefault();
    
    const msg = document.getElementById("message");
    const loader = document.getElementById("global-loader");
    const btn = document.getElementById("btn-submit");
    
    msg.style.display = "none";
    
    const salaVal = document.getElementById("sala").value;
    const qtd = parseInt(document.getElementById("quantidade").value);
    const emailVal = document.getElementById("email").value;

    // Nova Valida칞칚o de E-mail Institucional
    if (!emailVal.toLowerCase().endsWith("@brightbee.com.br")) {
        msg.innerText = "Por favor, utilize seu e-mail institucional (@brightbee.com.br).";
        msg.className = "msg-error";
        msg.style.display = "block";
        return;
    }

    // Valida칞칚o Final da Sala
    if (!salaVal || !validarSala(salaVal).valido) {
        msg.innerText = "Preencha uma sala v치lida.";
        msg.className = "msg-error";
        msg.style.display = "block";
        return;
    }

    if (qtd > 25 || qtd > totalEstoque) {
      msg.innerText = `Quantidade inv치lida (M치x permitido: ${Math.min(25, totalEstoque)}).`;
      msg.className = "msg-error";
      msg.style.display = "block";
      return;
    }

    const selecionados = Array.from(document.querySelectorAll("input[name='h']:checked")).map(i => i.value);
    if (selecionados.length === 0) {
      msg.innerText = "Selecione ao menos um hor치rio.";
      msg.className = "msg-error";
      msg.style.display = "block";
      return;
    }

    for (let h of selecionados) {
      const livres = disponibilidadeMap[h] !== undefined ? disponibilidadeMap[h] : totalEstoque;
      if (livres < qtd) {
        msg.innerText = `O hor치rio ${h} n칚o tem ${qtd} unidades dispon칤veis.`;
        msg.className = "msg-error";
        msg.style.display = "block";
        return;
      }
    }

    btn.disabled = true;
    loader.style.display = "block";

    const payload = {
      action: "fazerReserva",
      formData: {
        professor: document.getElementById("professor").value,
        email: emailVal,
        sala: salaVal,
        data: document.getElementById("data").value,
        quantidade: qtd,
        turma: salaVal, 
        horarios: selecionados
      }
    };

    callApi(payload).then(resp => {
      loader.style.display = "none";
      btn.disabled = false;
      
      if (resp.success) {
        msg.innerText = resp.message;
        msg.className = "msg-success";
        msg.style.display = "block";
        
        document.getElementById("reserva-form").reset();
        resetarCheckboxes();
        
        // Reseta para amanh칚
        const amanha = new Date();
        amanha.setDate(amanha.getDate() + 1);
        document.getElementById("data").min = amanha.toISOString().split("T")[0];
        
        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('sala')) {
            document.getElementById("sala").value = urlParams.get('sala');
            buscarEstoque();
        } else {
            document.getElementById("total-display").innerText = "Aguardando sala...";
        }
        
      } else {
        msg.innerText = resp.message;
        msg.className = "msg-error";
        msg.style.display = "block";
      }
    }).catch(err => {
      loader.style.display = "none";
      btn.disabled = false;
      msg.innerText = "Erro de comunica칞칚o com o servidor.";
      msg.className = "msg-error";
      msg.style.display = "block";
    });
  });
</script>

</body>
</html>
